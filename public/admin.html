<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dungeon of Habits Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Caesar+Dressing&display=swap" rel="stylesheet">
  <style>
    h1, h2, h3, h4 {
      font-family: 'Caesar Dressing', cursive;
    }
  </style>
  <script>
  let token = null;
  const API_BASE = "/api/admin";
  let confirmAction = null;

  // ---------- LOGIN ----------
  async function adminLogin() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json();
    if (data.token) {
      token = data.token;
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      loadUsers();
      loadMonsters();
      loadDungeons();
    } else {
      alert("Login failed: " + data.message);
    }
  }

  // ---------- CONFIRM MODAL ----------
  function openConfirm(title, message, onConfirm) {
    document.getElementById("confirm-title").textContent = title;
    document.getElementById("confirm-message").textContent = message;
    confirmAction = onConfirm;
    document.getElementById("confirm-modal").classList.remove("hidden");
  }

  function closeConfirm() {
    document.getElementById("confirm-modal").classList.add("hidden");
    confirmAction = null;
  }

  // Close modal with ESC or outside click
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeConfirm();
  });
  window.addEventListener("click", (e) => {
    if (e.target.id === "confirm-modal") closeConfirm();
  });

  // ---------- USERS ----------
  async function loadUsers() {
    const res = await fetch(`${API_BASE}/users`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const users = await res.json();
    const list = document.getElementById("user-list");
    list.innerHTML = "";
    users.forEach(u => {
      list.innerHTML += `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-2">${u.username}</td>
          <td class="px-4 py-2">Email: ${u.email}, Lvl: ${u.level}, Gold: ${u.gold}</td>
          <td class="px-4 py-2">
            <button onclick="confirmDeleteUser('${u._id}', '${u.username}')"
              class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-white">‚ùå</button>
          </td>
        </tr>
      `;
    });
  }

  async function deleteUser(id) {
    await fetch(`${API_BASE}/users/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
    loadUsers();
  }

  function confirmDeleteUser(id, username) {
    openConfirm("Delete User", `Are you sure you want to delete user "${username}"?`, () => deleteUser(id));
  }

  // ---------- MONSTERS ----------
  async function loadMonsters() {
    const res = await fetch(`${API_BASE}/monsters`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const monsters = await res.json();
    const list = document.getElementById("monster-list");
    list.innerHTML = "";
    monsters.forEach(m => {
      list.innerHTML += `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-2">
            <div>${m.name}</div>
            <div class="text-gray-400 text-sm">ID: ${m._id}</div>
          </td>
          <td class="px-4 py-2">
            ATK: ${m.atk}, DEF: ${m.def}, HP: ${m.hp}, XP: ${m.xpReward}, Gold: ${m.goldReward}
          </td>
          <td class="px-4 py-2">
            <button onclick="confirmDeleteMonster('${m._id}', '${m.name}')"
              class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-white">‚ùå</button>
          </td>
        </tr>
      `;
    });
  }

  async function addMonster() {
  const name = document.getElementById("m-name").value;
  const atk = document.getElementById("m-atk").value;
  const def = document.getElementById("m-def").value;
  const hp = document.getElementById("m-hp").value;
  const xp = document.getElementById("m-xp").value;
  const gold = document.getElementById("m-gold").value;

  const res = await fetch("/admin/monsters", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, atk, def, hp, xpReward: xp, goldReward: gold })
  });

  if (res.ok) {
    Swal.fire("Success", "Monster added!", "success");
    loadMonsters();

    // clear inputs
    document.getElementById("m-name").value = "";
    document.getElementById("m-atk").value = "";
    document.getElementById("m-def").value = "";
    document.getElementById("m-hp").value = "";
    document.getElementById("m-xp").value = "";
    document.getElementById("m-gold").value = "";
  } else {
    Swal.fire("Error", "Failed to add monster", "error");
  }
}


  async function deleteMonster(id) {
    await fetch(`${API_BASE}/monsters/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
    loadMonsters();
  }

  function confirmDeleteMonster(id, name) {
    openConfirm("Delete Monster", `Are you sure you want to delete monster "${name}"?`, () => deleteMonster(id));
  }

  // ---------- DUNGEONS ----------
  async function loadDungeons() {
    const res = await fetch(`${API_BASE}/dungeons`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const dungeons = await res.json();
    const list = document.getElementById("dungeon-list");
    list.innerHTML = "";
    dungeons.forEach(d => {
      const monsterNames = d.monsters.map(m => m.name).join(", ");
      list.innerHTML += `
        <tr class="border-b border-gray-700">
          <td class="px-4 py-2">Floor ${d.floor}</td>
          <td class="px-4 py-2">${monsterNames}</td>
          <td class="px-4 py-2">
            <button onclick="confirmDeleteDungeon('${d._id}', '${d.floor}')"
              class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-white">‚ùå</button>
          </td>
        </tr>`;
    });
  }

  async function addDungeon() {
  const floorStr = document.getElementById("d-floor").value.trim();
  const floor = parseInt(floorStr, 10);
  const monstersInput = document.getElementById("d-monsters").value;

  const monsterIds = monstersInput
    .split(",")
    .map(id => id.trim())
    .filter(id => id.length > 0);

  if (!floorStr || isNaN(floor) || monsterIds.length === 0) {
    Swal.fire("Error", "Please enter a valid floor number and at least one monster ID.", "error");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/dungeons`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ floor, monsters: monsterIds })
    });

    const data = await res.json();

    if (res.ok) {
      Swal.fire("Success", "Dungeon added!", "success");
      loadDungeons();
      document.getElementById("d-floor").value = "";
      document.getElementById("d-monsters").value = "";
    } else {
      Swal.fire("Error", data.error || data.message || "Failed to add dungeon", "error");
    }
  } catch (err) {
    Swal.fire("Error", err.message, "error");
  }
}


  async function deleteDungeon(id) {
    await fetch(`${API_BASE}/dungeons/${id}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` }
    });
    loadDungeons();
  }

  function confirmDeleteDungeon(id, floor) {
    openConfirm("Delete Dungeon", `Are you sure you want to delete dungeon floor ${floor}?`, () => deleteDungeon(id));
  }

  // ---------- INIT ----------
  window.onload = function () {
    document.getElementById("confirm-yes").onclick = function () {
      if (confirmAction) confirmAction();
      closeConfirm();
    };
  };
</script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">
  <!-- LOGIN -->
  <section id="login-section" class="flex items-center justify-center h-screen">
    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-80 text-center">
      <h2 class="text-2xl text-yellow-400 mb-6">Admin Login</h2>
      <input id="username" placeholder="Username" class="w-full mb-3 p-2 rounded bg-gray-700">
      <input id="password" type="password" placeholder="Password" class="w-full mb-3 p-2 rounded bg-gray-700">
      <button onclick="adminLogin()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-4 py-2 rounded">
        Login
      </button>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden p-8">
    <h1 class="text-3xl text-yellow-400 mb-6">Dungeon of Habits Admin Dashboard</h1>

    <!-- USERS -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-2xl text-blue-400 mb-4">üë• Manage Users</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="px-4 py-2">Username</th>
            <th class="px-4 py-2">Stats</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="user-list"></tbody>
      </table>
    </div>

    <!-- MONSTERS -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-2xl text-red-400 mb-4">üëπ Manage Monsters</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Stats</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="monster-list"></tbody>
      </table>

      <h3 class="text-lg text-gray-300 mt-6 mb-2">‚ûï Add Monster</h3>
      <div class="grid grid-cols-2 gap-2">
        <input id="m-name" placeholder="Name" class="p-2 rounded bg-gray-700">
        <input id="m-atk" placeholder="ATK" class="p-2 rounded bg-gray-700">
        <input id="m-def" placeholder="DEF" class="p-2 rounded bg-gray-700">
        <input id="m-hp" placeholder="HP" class="p-2 rounded bg-gray-700">
        <input id="m-xp" placeholder="XP Reward" class="p-2 rounded bg-gray-700">
        <input id="m-gold" placeholder="Gold Reward" class="p-2 rounded bg-gray-700">
      </div>
      <button onclick="addMonster()" class="mt-3 bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">
        Add Monster
      </button>
    </div>

    <!-- DUNGEONS -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl text-green-400 mb-4">üè∞ Manage Dungeons</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="px-4 py-2">Floor</th>
            <th class="px-4 py-2">Monsters</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="dungeon-list"></tbody>
      </table>

      <h3 class="text-lg text-gray-300 mt-6 mb-2">‚ûï Add Dungeon</h3>
      <div class="grid grid-cols-2 gap-2">
        <input id="d-floor" placeholder="Floor" class="p-2 rounded bg-gray-700">
        <input id="d-monsters" placeholder="Monster IDs (comma separated)" class="p-2 rounded bg-gray-700 col-span-2">
      </div>
      <button onclick="addDungeon()" class="mt-3 bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">
        Add Dungeon
      </button>
    </div>
  </section>
  <!-- DELETE CONFIRM MODAL -->
<div id="confirm-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 rounded-xl shadow-lg p-6 w-96 text-center">
    <h3 id="confirm-title" class="text-xl font-semibold text-red-400 mb-4">Confirm Delete</h3>
    <p id="confirm-message" class="text-gray-300 mb-6">Are you sure?</p>
    <div class="flex justify-center gap-4">
      <button onclick="closeConfirm()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-white">
        Cancel
      </button>
      <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">
        Delete
      </button>
    </div>
  </div>
</div>
</body>
</html>
